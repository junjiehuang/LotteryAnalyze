[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=4b20872b-4ae7-447e-bcb1-3edf1af2d123
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos
Dim FetchTodayData


// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
	
	dataPath = "dataPath.txt"
	isExist = Plugin.File.IsFileExist(dataPath)
	If isExist = True Then 
		fileHandle = Plugin.File.OpenFile(dataPath)
		patch = Plugin.File.ReadLine(fileHandle)
		If patch = "" Then 
			MessageBox patch
		Else 
			Form1.InputBoxSelectFolder.Text = patch
		End If
		Plugin.File.CloseFile (fileHandle)
	End If
	
	FetchTodayData = False
	If FetchTodayData Then
		DoForceFetch 
		Call Lib.系统.结束进程("AutoFetchDailyData.exe")
	End If
End Event

// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click
	DoForceFetch	
End Event

// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event

// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	If FetchTodayData Then 
		web_addr = "http://chart.cp.360.cn/kaijiang/ssccq?sb_spm=317565740c58744ae7d8654182515efa"
	Else
		web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	End If
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			If numStr = "- -" Then 
				numStr = "-"
			End If
			comStr = indexTag & " " & id & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "-" or indexStr = "-" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function

Function DoForceFetch()	
	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
End Function

Function DoRefetch()
	
//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
End Function

// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event

Event Form1.ButtonRefetch.Click
	DoRefetch
End Event

