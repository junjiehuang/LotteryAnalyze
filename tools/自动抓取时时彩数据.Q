[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=4b20872b-4ae7-447e-bcb1-3edf1af2d123
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
End Event


// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	
End Event


// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event


// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		//Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			comStr = indexTag & " " & indexStr & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "- -" or indexStr = "- -" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function


// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event



Event Form1.ButtonRefetch.Click

//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
	
End Event
