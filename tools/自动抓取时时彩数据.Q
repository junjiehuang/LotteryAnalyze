[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=a44f941e-e47c-4ef5-95aa-2433f3ec8151
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
End Event


// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	
End Event


// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event


// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		//Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			comStr = indexTag & " " & indexStr & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "- -" or indexStr = "- -" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function


// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event



Event Form1.ButtonRefetch.Click

//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
	
End Event
