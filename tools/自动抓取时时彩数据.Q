[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=a44f941e-e47c-4ef5-95aa-2433f3ec8151
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
End Event


// 执行数据抓取
Event Form1.ButtonStartCollect.Click

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD, totalDays, procCount
	//Y = Year(Date) : M = Month(Date) : D = Day(Date)
	//TodayStr = M & " " & D & ", " & Y
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 0
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat (TestDay)
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	
End Event


// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event


// 抓取指定日期的数据
Function AnalyzeOneDat(testDay)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	// 打开指定的网页
	Call Plugin.Web.Bind("WQM.exe")
	Call Plugin.Web.Go(web_addr)
	Hwnd = Plugin.Web.GetHwnd()
	Call Plugin.Web.SetSize(200, 500)
	Call Plugin.Window.Move(Hwnd,0,0)
	Call Plugin.Window.Size(Hwnd, 200, 500)
	
	wait_time = 0
	// 等待网页加载完毕
	Do While true
		Delay 500
		wait_time = wait_time + 500
		// 如果网页加载完毕，就退出等待状态
		If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
			Exit DO
		End If
		// 等待超时了也要退出等待状态，防止死循环
		If wait_time > 10000 Then 
			Exit DO
		End If
	Loop

	Dim i, id
	Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
	i = 1
	id = 1
	cmdInfo = "开始抓取 " & testDay & " 的网页信息" & vbCrLf
	fileTxt = ""
	
	// 循环抓取120期的数据
	For 120
		// 抓取期号
		indexTag = "tag:TD&index:" & i
		indexStr = Plugin.Web.HtmlGet("text", indexTag)
		i = i + 1
		// 抓取当期出的号数
		numTag = "tag:TD&index:" & i
		numStr = Plugin.Web.HtmlGet("text", numTag)
		comStr = indexTag & " " & indexStr & " " & numTag & " " & numStr & vbCrLf
		cmdInfo = cmdInfo & comStr
		i = i + 4
		id = id + 1
		
		If id = 42 Then
			i = 207
		ElseIf id = 83 then
			i = 413
		End If
		
		// 记录文件数据
		fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf
		
		// 输出到控制台
		Form1.InputBoxCmd.Text = cmdInfo
		// 更新进度条
		Form1.ProgressBarCollect.Value = (id / 120) * 100
			
		If numStr = "- -" or indexStr = "- -" Then 
			success = False
		End If
	Next
	
	If success = False Then 
		failedLst = failedLst & testDay & vbCrLf
		failedCount = failedCount + 1
	Else 
		successCount = successCount + 1
	End If
	
	Dim filePath
	// 将要写入的文件路径
	filePath = Form1.InputBoxSelectFolder.Text & "\" & TY & ""
	If TM < 10 Then 
		filePath = filePath & "0"
	End If
	filePath = filePath & TM & ""
	If TD < 10 Then 
		filePath = filePath & "0"
	End If
	filePath = filePath & TD & ".txt"
	
	// 删除原文件
	Call Plugin.File.DeleteFile(filePath)
	// 写入新文件
	Call Plugin.File.WriteFileEx(filePath, fileTxt)
	
	Delay 300
	// 关闭浏览器
	Call Plugin.Window.Close(Hwnd)
	Form1.InputBoxCmd.Text = ""
	Delay 300
	
End Function


// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event


