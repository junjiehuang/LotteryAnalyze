[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=4b20872b-4ae7-447e-bcb1-3edf1af2d123
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
End Event


// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	
End Event


// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event


// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		//Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			If numStr = "- -" Then 
				numStr = "-"
			End If
			comStr = indexTag & " " & id & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "-" or indexStr = "-" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function


// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event



Event Form1.ButtonRefetch.Click

//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
	
End Event
