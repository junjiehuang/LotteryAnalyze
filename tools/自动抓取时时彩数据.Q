[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=4b20872b-4ae7-447e-bcb1-3edf1af2d123
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
	fileHandle = Plugin.File.OpenFile("dataPath.txt")
	Form1.InputBoxSelectFolder.Text = Plugin.File.ReadLine(fileHandle)
	Plugin.File.CloseFile (fileHandle)
	
	//DoForceFetch 
	//hwnd = Plugin.Window.Foreground
	//Plugin.Window.CloseEx(hwnd)
End Event

// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click
	DoForceFetch	
End Event

// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event

// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		//Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			If numStr = "- -" Then 
				numStr = "-"
			End If
			comStr = indexTag & " " & id & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "-" or indexStr = "-" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function

Function DoForceFetch()	
	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
End Function

Function DoRefetch()
	
//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
End Function

// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event

Event Form1.ButtonRefetch.Click
	DoRefetch
End Event

