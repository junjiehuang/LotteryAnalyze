[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=a44f941e-e47c-4ef5-95aa-2433f3ec8151
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
End Event


// 执行数据抓取
Event Form1.ButtonStartCollect.Click

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	
End Event


// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event


// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath
	// 将要写入的文件路径
	filePath = Form1.InputBoxSelectFolder.Text & "\" & TY & ""
	If TM < 10 Then 
		filePath = filePath & "0"
	End If
	filePath = filePath & TM & ""
	If TD < 10 Then 
		filePath = filePath & "0"
	End If
	filePath = filePath & TD & ".txt"

	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			fileDataLength = Plugin.File.GetFileLength(filePath)
			//MessageBox isFileExist & " " & fileDataLength
			If fileDataLength >= 1322 Then 
				needReCache = False
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		//Call Plugin.Web.Refresh(0)  
		Hwnd = Plugin.Web.GetHwnd()
		Call Plugin.Window.Hide(Hwnd)  
		Call Plugin.Web.SetSize(200, 300)
		//Call Plugin.Window.Move(Hwnd,0,0)
		//Call Plugin.Window.Size(Hwnd, 200, 500)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			comStr = indexTag & " " & indexStr & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "- -" or indexStr = "- -" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function


// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event



Event Form1.ButtonRefetch.Click

//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	
End Event
