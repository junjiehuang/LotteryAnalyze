[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=4b20872b-4ae7-447e-bcb1-3edf1af2d123
Description=自动抓取时时彩数据
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos

// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
	fileHandle = Plugin.File.OpenFile("dataPath.txt")
	Form1.InputBoxSelectFolder.Text = Plugin.File.ReadLine(fileHandle)
	Plugin.File.CloseFile (fileHandle)
	
	//DoForceFetch 
	//Call Lib.系统.结束进程("AutoFetchDailyData.exe")
End Event

// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click
	DoForceFetch	
End Event

// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event

// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	// 合成网页地址
	web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		//Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			If numStr = "- -" Then 
				numStr = "-"
			End If
			comStr = indexTag & " " & id & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "-" or indexStr = "-" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function

Function DoForceFetch()	
	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
End Function

Function DoRefetch()
	
//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
End Function

// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event

Event Form1.ButtonRefetch.Click
	DoRefetch
End Event

