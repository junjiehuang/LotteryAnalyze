[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=4b20872b-4ae7-447e-bcb1-3edf1af2d123
Description=自动抓取时时彩数据_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]

Dim catchFailedInfo, catchSuccessInfo, successCount, failedCount, failedLst, totalProcStr
Dim procCount, totalDays, invalidFileInfos
Dim FetchTodayData


// 初始化窗口
Event Form1.Load
	Dim Y, M, D
	Y = Year(Date) : M = Month(Date) : D = Day(Date)
	Form1.InputBoxEndY.Text = Y
	Form1.InputBoxEndM.Text = M
	Form1.InputBoxEndD.Text = D
	Form1.InputBoxStartY.Text = Y
	Form1.InputBoxStartM.Text = M
	Form1.InputBoxStartD.Text = D
	
	dataPath = "dataPath.txt"
	isExist = Plugin.File.IsFileExist(dataPath)
	If isExist = True Then 
		fileHandle = Plugin.File.OpenFile(dataPath)
		patch = Plugin.File.ReadLine(fileHandle)
		If patch = "" Then 
			MessageBox patch
		Else 
			Form1.InputBoxSelectFolder.Text = patch
		End If
		Plugin.File.CloseFile (fileHandle)
	End If
	
	FetchTodayData = False
	If FetchTodayData Then
		DoForceFetch 
		Call Lib.系统.结束进程("AutoFetchDailyData.exe")
	End If
End Event

// 执行数据抓取(强制抓取)
Event Form1.ButtonStartCollect.Click
	DoForceFetch	
End Event

// 选择文件夹
Event Form1.ButtonOutPutFolder.Click
	Form1.InputBoxSelectFolder.Text = Plugin.File.SelectDirectory()
End Event

// 抓取指定日期的数据
Function AnalyzeOneDat(testDay, forceCache)

	Dim CY, CM, CD
	CY = Year(Date) : CM = Month(Date) : CD = Day(Date)
	
	Dim success
	success = True
	
	// 初始化进度条
	Form1.ProgressBarCollect.Value = 0
	// 初始化命令输出
	Form1.InputBoxCmd.Text = ""
	
	Dim TY, TM, TD, web_addr, wait_time, isToday
	// 年
	TY = Year(testDay)
	// 月
	TM = Month(testDay)
	// 日
	TD = Day(testDay)
	isToday = (TY = CY and TM = CM and TD = CD)
	// 合成网页地址
	If FetchTodayData or isToday Then 
		web_addr = "http://chart.cp.360.cn/kaijiang/ssccq?sb_spm=317565740c58744ae7d8654182515efa"
	Else
		web_addr = "http://chart.cp.360.cn/kaijiang/kaijiang?lotId=255401&spanType=2&span=" & TY & "-" & TM & "-" & TD & "_" & TY & "-" & TM & "-" & TD
	End If
	Form1.InputBoxCurDay.Text = testDay
	
	Dim filePath, fileName
	// 将要写入的文件路径
	fileName = TY
	If TM < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TM
	If TD < 10 Then 
		fileName = fileName & "0"
	End If
	fileName = fileName & TD & ".txt"
	filePath = Form1.InputBoxSelectFolder.Text & "\" & fileName

	// 判断是否需要重新抓取
	Dim needReCache, isFileExist, fileDataLength
	needReCache = True
	If forceCache = False Then 
		// 判断目标数据文件是否存在
		isFileExist = Plugin.File.IsFileExist(filePath)		
		If isFileExist = True Then 
			// 判断文件数据大小是否没有遗漏了
			fileDataLength = Plugin.File.GetFileLength(filePath)
			If fileDataLength >= 1322 Then 
				needReCache = False
			Else 
				invalidFileInfos = invalidFileInfos & fileName & " : " & fileDataLength & vbCrLf
			End If
		End If
	End If 
	
	If needReCache = True Then 
		// 打开指定的网页
		Call Plugin.Web.Bind("WQM.exe")
		Call Plugin.Web.Go(web_addr)
		Call Plugin.Web.SetSize(200, 500)
		Hwnd = Plugin.Web.GetHwnd()
		Hwnd = Plugin.Window.Foreground()  		
		Call Plugin.Window.Min(Hwnd)
	
		wait_time = 0
		// 等待网页加载完毕
		Do While true
			Delay 500
			wait_time = wait_time + 500
			// 如果网页加载完毕，就退出等待状态
			If "complete" = Plugin.Web.RunJS(1, "return document.readyState") Then 
				Exit DO
			End If
			// 等待超时了也要退出等待状态，防止死循环
			If wait_time > 10000 Then 
				Exit DO
			End If
		Loop

		Dim i, id
		Dim indexStr, numStr, indexTag, numTag, cmdInfo, comStr, fileTxt
		i = 1
		id = 1
		cmdInfo = "开始抓取 [ " & testDay & " ] 的数据" & vbCrLf
		fileTxt = ""
		totalProcStr =  "所有进度 ： " & procCount & " / " & totalDays & vbCrLf
	
		// 循环抓取120期的数据
		For 120
			// 抓取期号
			indexTag = "tag:TD&index:" & i
			indexStr = Plugin.Web.HtmlGet("text", indexTag)
			i = i + 1
			// 抓取当期出的号数
			numTag = "tag:TD&index:" & i
			numStr = Plugin.Web.HtmlGet("text", numTag)
			If numStr = "- -" Then 
				numStr = "-"
			End If
			comStr = indexTag & " " & id & " " & numTag & " " & numStr & vbCrLf
			
			i = i + 4
			id = id + 1
			
			If id = 42 Then
				i = 207
			ElseIf id = 83 then
				i = 413
			End If
			
			// 记录文件数据
			fileTxt = fileTxt & indexStr & " " & numStr & vbCrLf		
	
			// 更新进度条
			Form1.ProgressBarCollect.Value = (id / 120) * 100
				
			If numStr = "-" or indexStr = "-" Then 
				success = False
			End If
			
			// 输出到控制台
			cmdInfo = cmdInfo & comStr
			Form1.InputBoxCmd.Text = cmdInfo
			//Form1.InputBoxCmd.Text = cmdInfo & "当前进度 ： " & id & " / 120" & vbCrLf & totalProcStr
		Next
	
		If success = False Then 
			failedLst = failedLst & testDay & vbCrLf
			failedCount = failedCount + 1
		Else 
			successCount = successCount + 1
		End If
		
		// 删除原文件
		Call Plugin.File.DeleteFile(filePath)
		// 写入新文件
		Call Plugin.File.WriteFileEx(filePath, fileTxt)
		
		Delay 300
		// 关闭浏览器
		Call Plugin.Window.Close(Hwnd)
		Form1.InputBoxCmd.Text = ""
		Delay 300
		
	Else 
	
		successCount = successCount + 1
		Form1.InputBoxCmd.Text = ""
	
	End If	
	
End Function

Function DoForceFetch()	
	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, true
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
End Function

Function DoRefetch()
	
//	Length = Plugin.File.GetFileLength("D:\UnityProjs\LotteryAnalyze.git\trunk\data\20101211.txt")
//	MessageBox "file data size = " & Length

//	返回值 = Lib.文件.遍历指定目录下所有文件名(Form1.InputBoxSelectFolder.Text)
//	MessageBox "文件总数： " & UBound(返回值) & " " & 返回值(i)	

	successCount = 0
	failedCount = 0
	catchSuccessInfo = "抓取成功的个数： "
	catchFailedInfo = "抓取失败的个数： "
	failedLst = ""
	invalidFileInfos = ""

    //当窗体被加载时触发的事件
    Dim Y, M, D, Today, Tomorrow, TestDay, TestDayStr, TodayStr, NewData, StartY, StartM, StartD
    Dim web_addr,TY, TM, TD
	TodayStr = Form1.InputBoxEndM.Text & " " & Form1.InputBoxEndD.Text & ", " & Form1.InputBoxEndY.Text
	Today = DateAdd("d", 0, TodayStr)
	Tomorrow = DateAdd("d", 1, TodayStr)
	
	StartY = Form1.InputBoxStartY.Text
	StartM = Form1.InputBoxStartM.Text
	StartD = Form1.InputBoxStartD.Text
	TestDayStr = StartM & " " & StartD & ", " & StartY
	TestDay = DateAdd("d", 0, TestDayStr)
	Form1.InputBoxCmd.Text = "开始抓取 " & TestDay & " - " & Today & "的网页信息"

	totalDays = DateDiff("d", TestDayStr, Tomorrow)
	procCount = 1
	Form1.ProgressBarTotal.Value = 0

	// 遍历指定的所有日期
	While Not (TestDay Eqv Tomorrow) 
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
		TY = Year(TestDay)
		TM = Month(TestDay)
		TD = Day(TestDay)
		TestDayStr = TM & " " & TD & ", " & TY
		// 抓取指定日期的数据
		AnalyzeOneDat TestDay, False
		TestDay = DateAdd("d", 1, TestDayStr)
		procCount = procCount + 1
		Form1.ProgressBarTotal.Value = procCount * 100 / totalDays
	Wend
	
	catchSuccessInfo = catchSuccessInfo & successCount & vbCrLf
	catchFailedInfo = catchFailedInfo & failedCount & vbCrLf
	Form1.InputBoxCmd.Text = "结束所有操作！" & vbCrLf & catchSuccessInfo & catchFailedInfo & failedLst
	Form1.ProgressBarCollect.Value = 100
	Form1.ProgressBarTotal.Value = 100
	MessageBox "重新拉取的文件 : " & vbCrLf & invalidFileInfos
End Function

// 打开数据文件夹
Event Form1.ButtonOpenDataFolder.Click

	RunApp Form1.InputBoxSelectFolder.Text
	
End Event

Event Form1.ButtonRefetch.Click
	DoRefetch
End Event

